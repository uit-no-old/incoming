---
- name: have docker-py
  remote_user: root
  pip: name=docker-py

- name: have ~/{{ image_file_name }}_project directory
  remote_user: "{{ host_build_user }}"
  file: dest="/home/{{ host_build_user }}/{{ image_file_name }}_project" state=directory

- name: synchronize project directory
  remote_user: "{{ host_build_user }}"
  synchronize: src="../../../{{ dockerfile_dir }}/"
      dest="/home/{{ host_build_user }}/{{ image_file_name }}_project/" owner=no
  register: sync_project

- name: build docker image if sync changed anything
  remote_user: root
  docker_image: name={{ image_name }} tag={{ image_tag }}
      path="/home/{{ host_build_user }}/{{ image_file_name }}_project" state=build
  #when: False
  when: sync_project.changed

- name: save docker image to file if we built a new image
  remote_user: root
  shell: docker save {{ image_name }} | gzip > /home/{{ host_build_user }}/{{ image_file_name }}.tar.gz
  #when: False
  when: sync_project.changed

- name: download image if we made a new one
  remote_user: "{{ host_build_user }}"
  synchronize: mode=pull src=/home/{{ host_build_user }}/{{ image_file_name }}.tar.gz
      dest={{ image_storage_dir }}/
      owner=no 
  when: sync_project.changed

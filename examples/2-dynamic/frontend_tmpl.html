<html>
<head>
<script src="http://{{incoming_host}}:{{incoming_port}}/frontend/incoming.js"></script>
<script type="text/javascript">

window.onload = function() {
    // make sure that the incoming lib has loaded. This might not be the case
    // if some browser add-on has blocked it.
    if (typeof incoming === 'undefined') {
        var output_state_msg = document.getElementById("stats_state_msg");
        output_state_msg.innerHTML = "Did not load incoming lib - was it blocked? Is the incoming server offline?";
        return;
    }

    // before we do any uploads, we have to tell incoming!! the host:port of the
    // incoming!! server
    incoming.set_server_hostname("{{incoming_host}}:{{incoming_port}}");
};

function handleFileSelect(evt) {
    var uploader = null;

    var input_file_select = document.getElementById("input_file");
    var input_pause = document.getElementById("input_pause");
    var input_btn_cancel = document.getElementById("input_btn_cancel");
    var output_state_msg = document.getElementById("stats_state_msg");
    var output_error_msg = document.getElementById("stats_error_msg");
    var output_cancel_msg = document.getElementById("stats_cancel_msg");
    var output_connected = document.getElementById("stats_connected");
    var output_cancelling = document.getElementById("stats_cancelling");
    var output_cancelled = document.getElementById("stats_cancelled");
    var output_finished = document.getElementById("stats_finished");
    var output_chunks_tx = document.getElementById("stats_chunks_tx");
    var output_chunks_acked = document.getElementById("stats_chunks_acked");
    var output_chunks_ahead = document.getElementById("stats_chunks_ahead");
    var output_kb_tx = document.getElementById("stats_kb_tx");
    var output_kb_acked = document.getElementById("stats_kb_acked");
    var output_kb_ahead = document.getElementById("stats_kb_ahead");

    input_file_select.disabled = true;

    // click handler for cancel button
    var cancel_clicked = function() {
        uploader.cancel("user cancelled manually");
    };
    input_btn_cancel.onclick = cancel_clicked;

    // click handler for pause checkbox
    var pause_clicked = function() {
        if (input_pause.checked) {
            uploader.pause("pause");
        } else {
            uploader.pause("unpause");
        }
    };
    input_pause.onclick = pause_clicked;

    // uploader callback for updating all the HTML things
    var update = function(uploader) {
        output_state_msg.innerHTML = uploader.state_msg;
        output_error_msg.innerHTML = uploader.error_msg;
        output_cancel_msg.innerHTML = uploader.cancel_msg;
        output_connected.innerHTML = uploader.connected.toString();
        output_cancelling.innerHTML = uploader.cancelling.toString();
        output_cancelled.innerHTML = uploader.cancelled.toString();
        output_finished.innerHTML = uploader.finished.toString();
        output_chunks_tx.innerHTML = uploader.chunks_tx_now.toString();
        output_chunks_acked.innerHTML = uploader.chunks_acked_now.toString();
        output_chunks_ahead.innerHTML = uploader.chunks_ahead.toString();
        output_kb_tx.innerHTML = Math.round(uploader.bytes_tx / 1024);
        output_kb_acked.innerHTML = Math.round(uploader.bytes_acked / 1024);
        output_kb_ahead.innerHTML = Math.round((uploader.bytes_tx - uploader.bytes_acked) / 1024);

        input_file_select.disabled = !(uploader.cancelled || uploader.finished);
        input_pause.disabled = !uploader.can_pause;
        input_pause.checked = uploader.paused;
        input_btn_cancel.disabled = !uploader.can_cancel;
    }

    var f = evt.target.files[0]; // f is a File object
    if (typeof f === 'undefined') { return; }

    // get an upload id from "my" backend (not incoming!! directly)
    // Note that you could implement this differently. For example, you could
    // let your backend make an upload id before delivering this page to the
    // browser, and then deliver the id together with the page, thus making this
    // request unneccessary.
    // TODO: make another, simpler but less dynamic example.
    var upload_id = "";
    var xhr = new XMLHttpRequest();
    xhr.open('get', "/frontend/request_upload?filename=" + f.name);
    xhr.onreadystatechange = function() {
        if (xhr.readyState == 4) {
            if (xhr.status == 200) {
                upload_id = xhr.responseText;

                // when we got our id, we can start uploading!
                uploader = incoming.Uploader(upload_id, f);
                uploader.onprogress = update;
                uploader.onfinished = update;
                uploader.oncancelled = update;
                uploader.onerror = update;
                window.onbeforeunload = function(e) { uploader.cancel("browser window unload"); };
                uploader.start();

            } else {
                alert(xhr.responseText);
            }
        }
    };
    xhr.send(null);
}
</script>
</head>

<body>
<p>
<input type="file" id="input_file" name="files[]"/><br/>
<input type="checkbox" id="input_pause" disabled/>pause<br/>
<button id="input_btn_cancel" disabled/>cancel</button><br/>
</p>
<p><table>
    <tr><td>State message:</td><td><output id="stats_state_msg"></output></td></tr>
    <tr><td>Error message:</td><td><output id="stats_error_msg"></output></td></tr>
    <tr><td>Cancel message:</td><td><output id="stats_cancel_msg"></output></td></tr>
    <tr><td>Connected:</td><td><output id="stats_connected"></output></td></tr>
    <tr><td>Cancelling:</td><td><output id="stats_cancelling"></output></td></tr>
    <tr><td>Cancelled:</td><td><output id="stats_cancelled"></output></td></tr>
    <tr><td>Finished:</td><td><output id="stats_finished"></output></td></tr>
    <tr><td>Chunks tx:</td><td><output id="stats_chunks_tx"></output></td></tr>
    <tr><td>Chunks acked:</td><td><output id="stats_chunks_acked"></output></td></tr>
    <tr><td>Chunks ahead:</td><td><output id="stats_chunks_ahead"></output></td></tr>
    <tr><td>KB tx:</td><td><output id="stats_kb_tx"></output></td></tr>
    <tr><td>KB acked:</td><td><output id="stats_kb_acked"></output></td></tr>
    <tr><td>KB ahead:</td><td><output id="stats_kb_ahead"></output></td></tr>
</table></p>
</body>

<script type="text/javascript">
document.getElementById('input_file').addEventListener('change', handleFileSelect, false);
</script>

</html>
